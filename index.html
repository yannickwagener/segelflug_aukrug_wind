<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aukrug Wind</title>

  <meta name="theme-color" content="#fafafa">
</head>

<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
  }
</style>

<body>
<div style="display: flex;width: 100%; height: 100%; justify-content: center; align-items: center;">
  <div style="width: 800px">
    <div style="padding: 10px">
      <div style="display: flex; align-items: center; justify-content: space-between">
        <h1 style="flex: 1;">Wind: <span id="direction">--</span></h1>
        <div style="display: flex; justify-content: space-between; align-items: center; flex: 1;">
          <h3>Min/Max: <span id="minmax">--</span></h3>
          <img id="direction_arrow" width="60px" height="60px" src="assets/arrow_down.png" alt="direction_arrow">
        </div>
      </div>
      <div>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <h2 id="label_29">Piste 29: <span id="runway_29">--</span></h2>
          <div style="border-bottom: 1px solid black;">
            <img id="direction_arrow29" width="40px" height="40px" src="assets/arrow_down.png" alt="direction_arrow">
          </div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <h2 id="label_11">Piste 11: <span id="runway_11">--</span></h2>
          <div style="border-bottom: 1px solid black;">
            <img id="direction_arrow11" width="40px" height="40px" src="assets/arrow_down.png" alt="direction_arrow">
          </div>
        </div>
      </div>
    </div>
    <div
      class="owm-widget"
      data-id="WB1624"
      data-show-live="no"
      data-show-2h="yes"
      data-show-24h="no"
    ></div>
    <div style="padding: 10px;">
      <h4>Aufnahmezeitpunkt: <span id="snapshot_timestamp">--</span></h4>
      <h4>Aktualisierung: <span id="last_fetch">--</span></h4>
    </div>
  </div>
</div>

<script>
  let windData = undefined;

  const getWind = async () => {
    try {
      const response = await fetch("https://api.pioupiou.fr/v1/live/1624");
      const json = await response.json();
      return json.data.measurements;
    } catch (error) {
      console.error("Error fetching wind data:", error);
      return null;
    }
  }

  const getTimeAgo = (timestamp) => {
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;

    const diffSec = Math.floor(diffMs / 1000);
    if (diffSec < 60) {
      return `vor ${diffSec} Sekunden`;
    }

    const diffMin = Math.floor(diffSec / 60);
    if (diffMin < 60) {
      return `vor ${diffMin} Minuten`;
    }
  };

  const calculateWindRelativeToRunway = (windHeading, runwayHeading) => {
    let diff = windHeading - runwayHeading;
    // normalize
    let result = ((diff % 360) + 360) % 360;
    if (result > 180) {
      result -= 360;
    }

    return result;
  };

  const calculateRelativeWindComponent = (windHeading, windSpeed, runwayHeading) => {
    const rad = deg => deg * (Math.PI / 180);

    let diff = windHeading - runwayHeading;
    //normalize
    diff = ((diff % 360) + 360) % 360;
    if (diff > 180) diff -= 360;

    const value = Math.cos(rad(diff)) * windSpeed;
    return Math.round(value);
  }

  const calculateWind = async () => {
    windData = await getWind();

    if (windData) {
      console.log(windData) //keep for debugging
      const refreshTime = new Date();

      const fetchTimeElement = document.getElementById("last_fetch");
      const directionElement = document.getElementById("direction");
      const minmaxElement = document.getElementById("minmax")
      const runway29Element = document.getElementById("runway_29");
      const label29Element = document.getElementById("label_29");
      const label11Element = document.getElementById("label_11");
      const runway11Element = document.getElementById("runway_11");
      const directionArrowElement = document.getElementById("direction_arrow");
      const directionArrowElement29 = document.getElementById("direction_arrow29");
      const directionArrowElement11 = document.getElementById("direction_arrow11");

      fetchTimeElement.innerText = refreshTime.toLocaleString();
      const windHeadingString = String(Math.round(windData.wind_heading)).padStart(3, "0");
      const windSpeedAvgString = Math.round(windData.wind_speed_avg);
      directionElement.innerText = `${windHeadingString} | ${windSpeedAvgString} km/h`;
      const windMinMaxString = `${Math.round(windData.wind_speed_min)} / ${Math.round(windData.wind_speed_max)} km/h`;
      minmaxElement.innerText = windMinMaxString;
      const offset29 = calculateWindRelativeToRunway(windData.wind_heading, 288);
      const offset11 = calculateWindRelativeToRunway(windData.wind_heading, 108); //source segelflug-aukrug.de
      const relativeWindComp29 = calculateRelativeWindComponent(windData.wind_heading, windData.wind_speed_avg, 288);
      const relativeWindComp11 = calculateRelativeWindComponent(windData.wind_heading, windData.wind_speed_avg, 108);
      runway29Element.innerText = `${relativeWindComp29} km/h`;
      runway11Element.innerText = `${relativeWindComp11} km/h`;
      label29Element.style = relativeWindComp29 >= 0 ? "color: black;" : "color: red;"
      label11Element.style = relativeWindComp11 >= 0 ? "color: black;" : "color: red;"
      directionArrowElement.style = `transform: rotate(${windData.wind_heading}deg);`;
      directionArrowElement29.style = `transform: rotate(${offset29}deg);`;
      directionArrowElement11.style = `transform: rotate(${offset11}deg);`;

    }

  }

  const calculateDateDiff = () => {
    if (windData) {
      const snapshot_element = document.getElementById("snapshot_timestamp");
      const date = new Date(windData.date);
      snapshot_element.innerText = `${getTimeAgo(date)} (${date.toLocaleString()})`;
    }
  }

  const onVisibilityChange = () => {
    if (!document.hidden) {
      calculateWind().then(calculateDateDiff);
    }
  }


  //initial calls
  calculateWind().then(calculateDateDiff);
  //scheduling
  setInterval(calculateWind, 1000 * 60);
  setInterval(calculateDateDiff, 1000 * 5);
  //event handler registration
  document.addEventListener("visibilitychange", onVisibilityChange)
</script>
<script src="https://www.openwindmap.org/js/widget-v1.js"></script>
</body>
</html>
