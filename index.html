<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aukrug Wind</title>

  <meta name="theme-color" content="#fafafa">
</head>

<body>
<div style="display: flex;width: 100vw; height: 100vh; justify-content: center; align-items: center;">
  <div style="width: 800px">
    <div style="padding: 10px">
      <h1>Richtung: <span id="direction">--</span>°</h1>
      <div>
        <h1>Relativ zu Piste:</h1>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <h2>Piste 29: <span id="runway_29">--</span>°</h2>
          <div style="border-bottom: 1px solid black;">
            <img id="direction_arrow29" width="40px" height="40px" src="assets/arrow_down.png" alt="direction_arrow">
          </div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <h2>Piste 11: <span id="runway_11">--</span>°</h2>
          <div style="border-bottom: 1px solid black;">
            <img id="direction_arrow11" width="40px" height="40px" src="assets/arrow_down.png" alt="direction_arrow">
          </div>
        </div>
      </div>
      <h3>Letzte Aktualisierung: <span id="last_fetch">--</span></h3>
    </div>
    <div
      class="owm-widget"
      data-id="WB1624"
      data-show-live="yes"
      data-show-2h="yes"
      data-show-24h="no"
    ></div>
  </div>
</div>

<script>
  let windData = undefined;

  const getWind = async () => {
    try {
      const response = await fetch("https://api.pioupiou.fr/v1/live/1624");
      const json = await response.json();
      return json.data.measurements;
    } catch (error) {
      console.error("Error fetching wind data:", error);
      return null;
    }
  }

  const getTimeAgo = (timestamp) => {
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;

    const diffSec = Math.floor(diffMs / 1000);
    if (diffSec < 60) {
      return `vor ${diffSec} Sekunden`;
    }

    const diffMin = Math.floor(diffSec / 60);
    if (diffMin < 60) {
      return `vor ${diffMin} Minuten`;
    }
  };

  const calculateWindRelativeToRunway = (windHeading, runwayHeading) => {
    let diff = windHeading - runwayHeading;
    //normalize
    diff = ((diff + 180) % 360) - 180;

    return diff;
  };

  const calculateWind = async () => {
    windData = await getWind();

    if (windData) {
      console.log(windData) //keep for debugging
      const directionElement = document.getElementById("direction");
      const runway29Element = document.getElementById("runway_29");
      const runway11Element = document.getElementById("runway_11");
      const directionArrowElement29 = document.getElementById("direction_arrow29");
      const directionArrowElement11 = document.getElementById("direction_arrow11");
      directionElement.innerText = windData.wind_heading;
      const offset29 = calculateWindRelativeToRunway(windData.wind_heading, 288);
      const offset11 = calculateWindRelativeToRunway(windData.wind_heading, 108); //source segelflug-aukrug.de
      runway29Element.innerText = offset29;
      runway11Element.innerText = offset11;
      directionArrowElement29.style = `transform: rotate(${offset29}deg);`;
      directionArrowElement11.style = `transform: rotate(${offset11}deg);`;

    }

  }

  const calculateDateDiff = () => {
    if (windData) {
      const lastFetchElement = document.getElementById("last_fetch");
      lastFetchElement.innerText = getTimeAgo(windData.date);
    }
  }

  //initial calls
  calculateWind();
  calculateDateDiff()
  //scheduling
  setInterval(calculateWind, 1000 * 60);
  setInterval(calculateDateDiff, 1000 * 5)
</script>
<script src="https://www.openwindmap.org/js/widget-v1.js"></script>
</body>
</html>
